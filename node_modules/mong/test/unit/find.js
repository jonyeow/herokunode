var lib = require('../../index');
var should = require('should');
var sinon = require('sinon');
var MongoClient = require('mongodb').MongoClient;
var ObjectId = require('mongodb').ObjectID;

var db;
var collection;

function User() {

}

var random = Math.random();
var _id  = new ObjectId('52d3bca3e25e47fc2d860000');
var _id2 = new ObjectId('52d3bca3e25e47fc2d860300');

describe('Model.find', function () {
  before(function (done) {
    var uri = 'mongodb://localhost/mong-test2';
    MongoClient.connect(uri, function (err, _db) {
      if (err) return done(err);
      db = _db;
      collection = db.collection('users');
      should.exist(collection);

      lib.init(User, 'users');

      collection.insert({_id: _id, random: random}, function (err) {
        collection.insert({_id: _id2, random: Math.random()}, function (err) {
          lib.connect(uri, done);
        });
      });
      

    });
  });

  it('should find the objects already in the collection', function (done) {
    var expectation = sinon.mock();
    expectation.once();

    User.find({_id: _id})
    .on('data', expectation)
    .on('end', function () {
      if (!expectation.firstCall.args[0]._id.equals(_id)) throw new Error('Wrong _id');
      expectation.verify();
      done();
    });
  });
});